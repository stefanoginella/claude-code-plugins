name: Update tool versions

on:
  schedule:
    - cron: '0 8 * * 1'  # Monday 08:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Check for tool updates
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OUTPUT_CHANGES: "true"
        run: |
          output=$(bash scripts/update-tool-versions.sh 2>&1)
          echo "$output"

          # Capture change lines for the PR body
          changes=$(echo "$output" | grep '^CHANGE: ' || true)
          if [[ -n "$changes" ]]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"

            # Build markdown table for PR body
            {
              echo 'pr_body<<PREOF'
              echo '## Tool Version Updates'
              echo ''
              echo '| Component | Old | New |'
              echo '|-----------|-----|-----|'
              echo "$changes" | while IFS='|' read -r name old new; do
                name="${name#CHANGE: }"
                echo "| ${name} | ${old} | ${new} |"
              done
              echo ''
              # Include major bumps if any
              majors=$(echo "$output" | grep 'âš ' || true)
              if [[ -n "$majors" ]]; then
                echo '### Major bumps detected (not applied)'
                echo ''
                echo '```'
                echo "$majors"
                echo '```'
              fi
              echo 'PREOF'
            } >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR
        if: steps.check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ steps.check.outputs.pr_body }}
        run: |
          branch="chore/update-tool-versions-$(date +%Y%m%d)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stash the version updates so we can switch branches cleanly
          git stash --include-untracked

          # Check if branch already exists remotely
          if git ls-remote --exit-code origin "refs/heads/${branch}" >/dev/null 2>&1; then
            git fetch origin "${branch}"
            git checkout "${branch}"
            git reset --hard "origin/${{ github.event.repository.default_branch }}"
          else
            git checkout -b "${branch}"
          fi

          # Apply the version updates onto the branch
          git stash pop
          git add plugins/code-guardian/scripts/lib/tool-registry.sh plugins/code-guardian/scripts/ci-recommend.sh
          git commit -m "chore: update pinned tool versions" \
            -m "Automated weekly check for new releases of security tools."
          git push --force-with-lease -u origin "${branch}"

          # Create or update PR
          existing_pr=$(gh pr list --head "${branch}" --json number --jq '.[0].number' || true)
          if [[ -n "$existing_pr" ]]; then
            gh pr edit "$existing_pr" --body "$PR_BODY"
            echo "Updated existing PR #${existing_pr}"
          else
            gh pr create \
              --title "chore: update pinned security tool versions" \
              --body "$PR_BODY"
          fi
