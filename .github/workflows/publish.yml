name: Publish npm packages

on:
  push:
    branches: [main]
    paths:
      - 'plugins/*/.claude-plugin/plugin.json'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      plugins: ${{ steps.diff.outputs.plugins }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - id: diff
        name: Detect version changes
        run: |
          changed=()
          for plugin_json in plugins/*/.claude-plugin/plugin.json; do
            plugin_name=$(echo "$plugin_json" | cut -d'/' -f2)
            pkg_dir="packages/${plugin_name}"

            # Skip if no companion package exists
            [ -f "${pkg_dir}/package.json" ] || continue

            # Check if version actually changed
            if git diff HEAD~1 -- "$plugin_json" | grep -q '"version"'; then
              changed+=("${plugin_name}")
            fi
          done

          if [ ${#changed[@]} -eq 0 ]; then
            echo "plugins=[]" >> "$GITHUB_OUTPUT"
          else
            json=$(printf '%s\n' "${changed[@]}" | jq -R . | jq -sc .)
            echo "plugins=${json}" >> "$GITHUB_OUTPUT"
          fi

  publish:
    needs: detect-changes
    if: needs.detect-changes.outputs.plugins != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        plugin: ${{ fromJson(needs.detect-changes.outputs.plugins) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Prepublish
        run: bash scripts/prepublish.sh ${{ matrix.plugin }}

      - name: Determine npm tag
        id: tag
        working-directory: packages/${{ matrix.plugin }}
        run: |
          version=$(grep '"version"' package.json | sed 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
          if echo "$version" | grep -q '-'; then
            prerelease=$(echo "$version" | sed 's/.*-\([a-zA-Z]*\).*/\1/')
            echo "tag=${prerelease}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish
        working-directory: packages/${{ matrix.plugin }}
        run: npm publish --provenance --access public --tag ${{ steps.tag.outputs.tag }}