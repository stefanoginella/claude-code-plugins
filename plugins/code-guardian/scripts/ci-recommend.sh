#!/usr/bin/env bash
# Generate CI security scanning pipeline recommendations
# Usage: ci-recommend.sh --stack-json <file> --ci-system <system>
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/common.sh"
source "${SCRIPT_DIR}/lib/tool-registry.sh"

STACK_JSON=""
CI_SYSTEM=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --stack-json) STACK_JSON="$2"; shift 2 ;;
    --ci-system) CI_SYSTEM="$2"; shift 2 ;;
    *) shift ;;
  esac
done

if [[ -z "$STACK_JSON" ]] || ! [[ -f "$STACK_JSON" ]]; then
  log_error "Stack JSON required"
  exit 1
fi

# Parse stack
stack_data=$(cat "$STACK_JSON")
parse_json_array() {
  echo "$1" | tr -d '[]"' | tr ',' '\n' | tr -d ' ' | grep -v '^$'
}

languages=$(echo "$stack_data" | grep '"languages"' | sed 's/.*: *//;s/,$//')
has_docker=$(echo "$stack_data" | grep '"docker"' | sed 's/.*: *//;s/,$//' | tr -d ' ')
ci_systems=$(echo "$stack_data" | grep '"ciSystems"' | sed 's/.*: *//;s/,$//')
iac_tools=$(echo "$stack_data" | grep '"iacTools"' | sed 's/.*: *//;s/,$//')

# Auto-detect CI if not specified
if [[ -z "$CI_SYSTEM" ]]; then
  CI_SYSTEM=$(parse_json_array "$ci_systems" | head -1)
fi

if [[ -z "$CI_SYSTEM" ]]; then
  CI_SYSTEM="github-actions"
  log_info "No CI system detected, defaulting to GitHub Actions"
fi

# Determine which tools to include
tools=()
while IFS= read -r lang; do
  [[ -z "$lang" ]] && continue
  while IFS= read -r tool; do
    [[ -z "$tool" ]] && continue
    found=false
    for existing in "${tools[@]+"${tools[@]}"}"; do
      [[ "$existing" == "$tool" ]] && found=true && break
    done
    $found || tools+=("$tool")
  done < <(get_tools_for_stack "$lang" | tr ' ' '\n')
done < <(parse_json_array "$languages")

if [[ "$has_docker" == "true" ]]; then
  for tool in $(get_tools_for_stack "docker"); do
    found=false; for e in "${tools[@]+"${tools[@]}"}"; do [[ "$e" == "$tool" ]] && found=true && break; done
    $found || tools+=("$tool")
  done
fi
if echo "$iac_tools" | grep -q '[a-z]'; then
  for tool in $(get_tools_for_stack "iac"); do
    found=false; for e in "${tools[@]+"${tools[@]}"}"; do [[ "$e" == "$tool" ]] && found=true && break; done
    $found || tools+=("$tool")
  done
fi

# ── Generate CI config ────────────────────────────────────────────────
case "$CI_SYSTEM" in
  github-actions)
    cat <<'GHEOF'
# ============================================================
# GitHub Actions: Security Scanning Pipeline
# Generated by code-guardian
# Add this to .github/workflows/security.yml
# ============================================================

name: Security Scan

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6am

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Secret detection
      - name: Gitleaks (secret detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Multi-language SAST
      - name: Semgrep (SAST)
        uses: semgrep/semgrep-action@v1
        with:
          config: auto

GHEOF

    # Add language-specific steps
    for tool in "${tools[@]}"; do
      case "$tool" in
        trivy)
          cat <<'TRIVYEOF'
      # Vulnerability scanning
      - name: Trivy (vulnerability scan)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

TRIVYEOF
          ;;
        hadolint)
          cat <<'HADOEOF'
      # Dockerfile linting
      - name: Hadolint (Dockerfile lint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

HADOEOF
          ;;
        checkov)
          cat <<'CHECKOVEOF'
      # IaC scanning
      - name: Checkov (IaC security)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          quiet: true
          soft_fail: true

CHECKOVEOF
          ;;
        npm-audit)
          cat <<'NPMEOF'
      # Dependency audit
      - name: npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

NPMEOF
          ;;
        pip-audit)
          cat <<'PIPEOF'
      # Python dependency audit
      - name: pip-audit
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt
        continue-on-error: true

PIPEOF
          ;;
        bandit)
          cat <<'BANDITEOF'
      # Python SAST
      - name: Bandit (Python SAST)
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-results.json || true
        continue-on-error: true

BANDITEOF
          ;;
        gosec)
          cat <<'GOSECEOF'
      # Go SAST
      - name: gosec (Go SAST)
        uses: securego/gosec@master
        with:
          args: ./...

GOSECEOF
          ;;
      esac
    done
    ;;

  gitlab-ci)
    cat <<'GLEOF'
# ============================================================
# GitLab CI: Security Scanning Pipeline
# Generated by code-guardian
# Add this to .gitlab-ci.yml (or include it)
# ============================================================

stages:
  - security

variables:
  SECURE_LOG_LEVEL: "warn"

gitleaks:
  stage: security
  image: zricethezav/gitleaks:latest
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --no-banner
  artifacts:
    reports:
      secret_detection: gitleaks-report.json
    when: always
  allow_failure: true

semgrep:
  stage: security
  image: semgrep/semgrep:latest
  script:
    - semgrep --config auto --json --output semgrep-results.json .
  artifacts:
    paths:
      - semgrep-results.json
    when: always
  allow_failure: true

GLEOF

    for tool in "${tools[@]}"; do
      case "$tool" in
        trivy)
          cat <<'GLTRIVYEOF'
trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --format json --output trivy-results.json --severity CRITICAL,HIGH .
  artifacts:
    paths:
      - trivy-results.json
    when: always
  allow_failure: true

GLTRIVYEOF
          ;;
        checkov)
          cat <<'GLCHECKOVEOF'
checkov:
  stage: security
  image: bridgecrew/checkov:latest
  script:
    - checkov -d . --output json --quiet > checkov-results.json || true
  artifacts:
    paths:
      - checkov-results.json
    when: always
  allow_failure: true

GLCHECKOVEOF
          ;;
      esac
    done
    ;;

  *)
    cat <<GENERICEOF
# ============================================================
# Generic CI: Security Scanning Pipeline
# Generated by code-guardian
# Adapt to your CI system ($CI_SYSTEM)
# ============================================================

# Step 1: Secret detection
gitleaks detect --source . --report-format json --report-path gitleaks-report.json

# Step 2: SAST
semgrep --config auto --json --output semgrep-results.json .

# Step 3: Vulnerability scanning
trivy fs --format json --output trivy-results.json --severity CRITICAL,HIGH .

GENERICEOF

    for tool in "${tools[@]}"; do
      case "$tool" in
        hadolint) echo "# Dockerfile linting"; echo "hadolint Dockerfile"; echo "" ;;
        checkov) echo "# IaC scanning"; echo "checkov -d . --output json --quiet"; echo "" ;;
        npm-audit) echo "# JS dependency audit"; echo "npm audit --audit-level=high"; echo "" ;;
        pip-audit) echo "# Python dependency audit"; echo "pip-audit -r requirements.txt"; echo "" ;;
        bandit) echo "# Python SAST"; echo "bandit -r . -f json"; echo "" ;;
        gosec) echo "# Go SAST"; echo "gosec -fmt=json ./..."; echo "" ;;
      esac
    done
    ;;
esac
